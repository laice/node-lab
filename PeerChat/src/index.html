<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title id="page_title">PeerChat</title>
    <link href="style.css" rel="stylesheet" type="text/css">
    <script src="http://cdn.peerjs.com/0.3.9/peer.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <!-- nwjs
    <script src="../../common/src/ifp-utils/utils.js" type="application/javascript"></script>
    <script src="app.js" type="application/javascript"></script>
    -->
    <!-- node -->
    <script src="utils.js"></script>
    <script src="app.js"></script>


</head>

<div id="console">
    <textarea readonly id="console_output" rows="6" cols="64" style="resize: none"></textarea>
</div>
<div id="user-form">

        <label for="userid">User Name (optional)</label>
        <input type="text" id="userid" placeholder="Name" />
        <button id="okuser">Ok</button>

</div>
<div id="join-form" hidden>

    <label for="join-form-input">Host ID: </label>
    <input type="text" id="join-form-input" />
    <lable for="join-privacy-input">Share host peerlist? </lable>
    <input type="checkbox" checked value="privacy" id="join-privacy-input">
    <button id="join-form-button">Connect</button>

</div>
<div id="my-info" hidden>
    <label for="peerid">Share this to allow people to connect to you: </label>
    <div id="peerid"></div></div>
<div id="chat" hidden>
    <div id="chat-output">
        <textarea id="chat-output-text" readonly rows="6" cols="64" style="resize: none;"></textarea>
        <label for="chat-output-text">
            <select id="peerlist_public" size="6"></select>
            <select id="peerlist_private" size="6"></select>
        </label>
    </div>
    <div id="chat-input">

        <input type="text" id="chat-input-text">
        <label for="chat-input-text">
            <select id="send-chat-dest">
                <option>All</option>
                <option>Public</option>
                <option>Private</option>
                <option>Whisper</option>
            </select>
            <button id="send-chat">Send</button>

        </label>

    </div>
</div>
<div id="pending_peers_div" hidden>
    <select id="pending_peers" size="6"></select>
    <button id="allow-public">Allow Public</button>
    <button id="allow-private">Allow Private</button>
    <button id="pending-deny">Deny</button>

</div>


</body>
<script>

    $('#okuser').click(function(){
        var regex = /([a-zA-Z0-9]+)/g;
        var results = $('#userid').val().trim().match(regex);
        if(results[0] !== '' ) {
            console.log('valid username: ' + results[0]);
            PeerChat.init(results[0]);
            $('#user-form').hide();
            $('#chat').show();
            $('#my-info').show();
            $('#join-form').show();
            $('#pending-peers-div').show();
        } else {
            console.log('invalid username: ' + results);
        }

    });

    $('#join-form-button').click(function(){
        PeerChat.join($('#join-form-input').val().trim(), $('#join-privacy-input').is(':checked'));
        $('#join-form-input').val("");
    });
    //console.log(process.versions);
    $('#allow-public').click(function(){
        var name = $("#pending_peers option:selected").text();
        PeerChat.public_hello(name);
    });

    $('#allow-private').click(function(){
        var name = $("#pending_peers option:selected").text();
        PeerChat.private_hello(name);
    });

    $('#pending-deny').click(function(){
        var name = $('#pending_peers option:selected').text();
        for(var i = PeerChat.pending_peers.length; i >= 0; i--){
            if(PeerChat.pending_peers[i].name === name){
                PeerChat.pending_peers.splice(i, 1);
            }
        }

    });

    $('#send-chat').click(function(){
        var chat_dest = $('#send-chat-dest option:selected').text();

        switch(chat_dest){
            case "All":
                PeerChat.msg($('#chat-input-text').val());
                break;
            case "Public":
                PeerChat.msg.broadcastPublic($('#chat-input-text').val());
                break;
            case "Private":
                PeerChat.msg.broadcastPrivate($('#chat-input-text').val());
                break;
            case "Whisper":
                PeerChat.msg.private($('#chat-input-text').val(), $('#peerlist option:selected').text());
                break;

        }
        $('#chat-input-text').val("");


    });
</script>
</html>